<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Тест з ЦЗ — Симулятор (Debug)</title>
<style>
body{font-family:system-ui;background:#f3f4f6;margin:0;padding:24px;}
.container{max-width:900px;margin:0 auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.1);}
h1{margin:0 0 12px;font-size:22px;}
.question{margin:18px 0;padding:14px;border-radius:6px;border:1px solid #e5e7eb;}
.options{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
label.opt{padding:10px;border:1px solid #ddd;border-radius:6px;cursor:pointer;display:block;}
.controls{display:flex;justify-content:space-between;margin-top:16px;}
button{background:#0ea5a4;color:white;padding:8px 12px;border:none;border-radius:6px;cursor:pointer;}
button.secondary{background:#e5e7eb;color:#111;}
.timer{font-size:18px;font-weight:600;color:#b91c1c;margin-bottom:12px;}
input[type=text]{padding:8px;width:100%;margin-top:4px;border-radius:6px;border:1px solid #ccc;}
</style>
</head>
<body>
<div class="container">
<h1>Тест з Цивільного Захисту — Симулятор (Debug)</h1>

<div id="loginDiv">
  <label><strong>Введіть ПІБ:</strong></label><br>
  <input id="username" type="text" placeholder="Ваше ПІБ" />
  <button id="startTest" style="margin-top:12px;">Розпочати тест</button>
</div>

<div id="testDiv" style="display:none;">
  <div class="timer">Час: <span id="time">30:00</span></div>
  <p>Питань: <span id="total">1</span></p>
  <div id="app"></div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// ----- ПИТАННЯ для тесту -----
const allQuestions = [
  {id:1,text:"Що означає попереджувальний сигнал “Увага всім!”?",options:{A:"Потрібно негайно евакуюватися",B:"Увімкнути радіо/телебачення",C:"Виходити на вулицю",D:"Чекати на інструкції"}}
];

// ----- ВІДПОВІДІ -----
const answers = {1:"B"};

// ----- СТАН ТЕСТУ -----
let state = { index:0, choices:{}, showResults:false };
let testQuestions = [];

// ----- РОЗПОЧАТИ ТЕСТ -----
document.getElementById('startTest').addEventListener('click',()=>{
  const username = document.getElementById('username').value.trim();
  if(!username){ 
    alert("Будь ласка, введіть ПІБ"); 
    return; 
  }

  console.log("Тест розпочато:", username);
  document.getElementById('loginDiv').style.display='none';
  document.getElementById('testDiv').style.display='block';
  testQuestions = allQuestions;
  render();
  startTimer();
});

// ----- ТАЙМЕР -----
let timeLeft = 60; // 1 хв для тесту
let timerInterval;
function startTimer(){
  const timerEl = document.getElementById('time');
  timerInterval = setInterval(()=>{
    const m=Math.floor(timeLeft/60), s=timeLeft%60;
    timerEl.textContent=`${m}:${s.toString().padStart(2,'0')}`;
    if(timeLeft<=0){clearInterval(timerInterval); finishTest();}
    timeLeft--;
  },1000);
}

// ----- РЕНДЕР -----
function render(){
  const app = document.getElementById('app');

  if(state.showResults){
    clearInterval(timerInterval);
    const score = grade();
    const username = document.getElementById('username').value;
    console.log("Тест завершено. Балів:", score);

    app.innerHTML = `<div>
      <h2>Результати</h2>
      <p>Балів: <strong>${score}</strong> / ${testQuestions.length}</p>
      <button onclick="location.reload()">Пройти знову</button>
    </div>`;

    try{
      generatePDF(username, score, testQuestions.length);
    }catch(e){
      console.error("Помилка при генерації PDF:", e);
      alert("PDF не згенеровано. Перевірте консоль.");
    }
    return;
  }

  const q = testQuestions[state.index];
  app.innerHTML = `<div class='question'>
    <div><strong>Питання ${state.index+1}:</strong> ${q.text}</div>
    <div class="options">
      ${Object.entries(q.options).map(([k,v])=>`<label class='opt'><input type='radio' name='q${q.id}' value='${k}' ${state.choices[q.id]===k?'checked':''}> <strong>${k}.</strong> ${v}</label>`).join('')}
    </div>
    <div class="controls">
      <button class="secondary" onclick="prev()" ${state.index===0?'disabled':''}>Назад</button>
      <button class="secondary" onclick="next()" ${state.index===testQuestions.length-1?'disabled':''}>Далі</button>
      <button onclick="finishTest()">Завершити</button>
    </div>
  </div>`;

  document.querySelectorAll('input[type=radio]').forEach(r=>{
    r.addEventListener('change', e=>{
      state.choices[q.id]=e.target.value;
      console.log("Вибір питання", q.id, ":", e.target.value);
    });
  });
}

function prev(){state.index--;render();}
function next(){state.index++;render();}
function finishTest(){state.showResults=true;render();}
function grade(){let sc=0;for(const q of testQuestions){if(state.choices[q.id]===answers[q.id])sc++;}return sc;}

// ----- PDF -----
function generatePDF(username, score, total){
  const { jsPDF } = window.jspdf;
  console.log("Генеруємо PDF...");
  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.text(`Результати тесту з Цивільного Захисту`, 20, 20);
  doc.setFontSize(12);
  doc.text(`Ім'я: ${username}`, 20, 35);
  doc.text(`Балів: ${score} / ${total}`, 20, 45);
  doc.text(`Відсоток: ${Math.round(score/total*100)}%`, 20, 55);
  doc.save(`Результат_${username.replaceAll(' ','_')}.pdf`);
  console.log("PDF збережено");
}
</script>
</body>
</html>
